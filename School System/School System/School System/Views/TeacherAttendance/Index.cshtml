@model IEnumerable<School_System.Models.TeacherAttendance>
@{
    ViewBag.Title = "Teacher Attendance";
    var teachers = ViewBag.Teachers as List<Teacher>;
    int? selectedId = ViewBag.SelectedTeacherId as int?;
    int? selectedMonth = ViewBag.SelectedMonth as int?;
    string selectedStatus = ViewBag.SelectedStatus as string;

    var months = Enumerable.Range(1, 12).ToList();

    string GetMonthName(int month) => new DateTime(1, month, 1).ToString("MMMM");
}

<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-semibold text-gray-800">📊 Teacher Attendance Records</h2>
        @if (DateTime.Today.DayOfWeek == DayOfWeek.Sunday)
        {
            <div class="mt-8 text-center">
                <p class="text-indigo-600 font-semibold text-lg">
                    ☀️ Today is Sunday — Attendance not required.
                </p>
            </div>
        }
        else
        {
            <a href="@Url.Action("Mark", "TeacherAttendance")"
               class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow transition duration-200">
                ➕ Mark Attendance
            </a>
        }
    </div>

    <form method="get" asp-action="Filter" id="filterForm" class="mb-6 flex items-center gap-6">
        <input type="hidden" name="origin" value="Index" />

        <!-- Filter by Teacher -->
        <div>
            <select name="teacherId" id="teacherId"
                    class="w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="" selected="@(selectedId == null ? "selected" : null)">-- All Teachers --</option>
                @foreach (var teacher in teachers)
                {
                    <option value="@teacher.TeacherId" selected="@(selectedId == teacher.TeacherId ? "selected" : null)">
                        @teacher.FullName
                    </option>
                }
            </select>

            <select name="month" id="month"
                    class="w-40 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="" selected="@(selectedMonth == null ? "selected" : null)">-- All Months --</option>
                @foreach (var m in months)
                {
                    <option value="@m" selected="@(selectedMonth == m ? "selected" : null)">
                        @GetMonthName(m)
                    </option>
                }
            </select>

            <select name="status" id="status"
                    class="w-40 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="" selected="@(string.IsNullOrEmpty(selectedStatus) ? "selected" : null)">-- All Statuses --</option>
                <option value="present" selected="@(selectedStatus == "present" ? "selected" : null)">Present</option>
                <option value="absent" selected="@(selectedStatus == "absent" ? "selected" : null)">Absent</option>
                <option value="marked" selected="@(selectedStatus == "marked" ? "selected" : null)">Marked (Present or Absent)</option>
                <option value="unmarked" selected="@(selectedStatus == "unmarked" ? "selected" : null)">Unmarked</option>
            </select>

        </div>
    </form>

    <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Teacher</th>
                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Marked at</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                @foreach (var item in Model)
                {
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            @item.Date.ToString("dddd, dd MMM yyyy")
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            @item.Teacher.FullName
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            @if (item.Date.DayOfWeek == DayOfWeek.Sunday)
                            {
                                <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-semibold">Sunday</span>
                            }
                            else if (item.Remarks == "Unmarked")
                            {
                                <div class="relative inline-block" id="attendanceWrapper-@item.Id">
                                    <button class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-semibold hover:bg-yellow-200"
                                            onclick="toggleAttendanceMenu(@item.Id)">
                                        Unmarked ⬇
                                    </button>

                                    <div id="attendanceMenu-@item.Id"
                                          class="hidden absolute mt-2 w-28 bg-white border rounded-lg shadow-lg z-10">
                                        <form method="post" asp-action="QuickMark" class="block">
                                            <input type="hidden" name="teacherId" value="@item.Teacher.TeacherId" />
                                            <input type="hidden" name="isPresent" value="true" />
                                            <input type="hidden" name="origin" value="Index" />

                                            <input type="hidden" name="date" value="@item.Date.ToString("yyyy-MM-dd")" />
                                            <button type="submit" class="w-full text-left px-4 py-2 text-green-600 hover:bg-green-50">
                                                ✅ Present
                                            </button>
                                        </form>
                                        <form method="post" asp-action="QuickMark" class="block">
                                            <input type="hidden" name="teacherId" value="@item.Teacher.TeacherId" />
                                            <input type="hidden" name="isPresent" value="false" />
                                            <input type="hidden" name="origin" value="Index" />
                                            <input type="hidden" name="date" value="@item.Date.ToString("yyyy-MM-dd")" />
                                            <button type="submit" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50">
                                                ❌ Absent
                                            </button>
                                        </form>
                                    </div>



                                </div>
                            }
                            else if (item.IsPresent == true)
                            {
                                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-semibold">Present</span>
                            }
                            else if (item.IsPresent == false)
                            {
                                <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full font-semibold">Absent</span>
                            }
                            else
                            {
                                <span class="text-gray-400 font-semibold">-</span>
                            }
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            @item.Remarks
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    // Auto-submit form when any filter changes
    document.querySelectorAll('#filterForm select').forEach(select => {
        select.addEventListener('change', function () {
            document.getElementById('filterForm').submit();
        });
    });

    function toggleAttendanceMenu(id) {
        // Close other menus
        document.querySelectorAll('[id^="attendanceMenu-"]').forEach(menu => {
            if(menu.id !== `attendanceMenu-${id}`) {
                menu.classList.add('hidden');
            }
        });

        // Toggle clicked menu
        const menu = document.getElementById(`attendanceMenu-${id}`);
        menu.classList.toggle('hidden');
    }

    // Close menu on outside click
    document.addEventListener('click', function(event) {
        const openMenus = document.querySelectorAll('[id^="attendanceMenu-"]:not(.hidden)');

        openMenus.forEach(menu => {
            const wrapper = menu.parentElement;
            if (!wrapper.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
    });
</script>
