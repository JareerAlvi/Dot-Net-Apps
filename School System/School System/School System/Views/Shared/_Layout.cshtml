@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

@{
    Layout = null;

    var path = Context.Request.Path.Value?.ToLower();
    var isAuthPage = path.Contains("login") || path.Contains("register") || path.Contains("forgotpassword");
}

<!DOCTYPE html>
<html lang="en" x-data="{ sidebarOpen: false, profileOpen: false }" class="h-full bg-gray-100">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>@ViewData["Title"] - School Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<body class="h-full flex flex-col">

    <div class="flex flex-1 overflow-hidden">

        @if (!isAuthPage)
        {
            <!-- Sidebar and overlay -->
            <div>
                <!-- Dim overlay -->
                <div class="fixed inset-0 bg-black bg-opacity-40 z-10 transition-opacity duration-300"
                     x-show="sidebarOpen"
                     x-transition.opacity
                     x-on:click="sidebarOpen = false"
                     x-cloak>
                </div>

                <!-- Sidebar -->
                <div class="fixed z-20 inset-y-0 left-0 w-64 bg-white shadow-md transform transition-transform duration-300"
                     :class="{ '-translate-x-full': !sidebarOpen, 'translate-x-0': sidebarOpen }"
                     x-cloak>
                    <div class="p-4 ml-3 text-xl font-bold text-indigo-600 border-b border-gray-200">
                        School Portal
                    </div>

                    <nav class="p-4 space-y-2 text-indigo-800 text-sm font-medium">

                        @* Admin Sidebar *@
                        @if (User.IsInRole("Admin"))
                        {
                            <a href="/Admin/Index" class="block hover:bg-indigo-100 p-2 rounded">Dashboard</a>

                            <!-- Manage Users Dropdown -->
                            <div x-data="{ open: false }" class="select-none">
                                <button x-on:click="open = !open"
                                        class="w-full flex justify-between items-center p-2 rounded hover:bg-indigo-100 focus:outline-none"
                                        :aria-expanded="open.toString()" aria-controls="userMgmtDropdown">
                                    Manage Users
                                    <svg :class="{ 'rotate-180': open }"
                                         class="h-4 w-4 transform transition-transform duration-200"
                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>

                           
                                <!-- Dropdown Items -->
                                <div x-show="open" x-collapse x-cloak id="userMgmtDropdown" class="pl-4 mt-1 space-y-1 text-indigo-800">
                                    <a href="/Student/ManageStudents" class="block hover:bg-indigo-100 p-1 rounded">Manage Students</a>
                                    <a href="/Admin/ManageTeachers" class="block hover:bg-indigo-100 p-1 rounded">Manage Teachers</a>
                                </div>
                            </div>
                                      <div x-data="{ open: false }" class="select-none">
                                <button x-on:click="open = !open"
                                        class="w-full flex justify-between items-center p-2 rounded hover:bg-indigo-100 focus:outline-none"
                                        :aria-expanded="open.toString()" aria-controls="userMgmtDropdown">
                                    Manage Fees
                                    <svg :class="{ 'rotate-180': open }"
                                         class="h-4 w-4 transform transition-transform duration-200"
                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>

                                <!-- Dropdown Items -->
                                <div x-show="open" x-collapse x-cloak id="userMgmtDropdown" class="pl-4 mt-1 space-y-1 text-indigo-800">
                                    <a href="/Student/GenerateMonthlyFees" class="block hover:bg-indigo-100 p-1 rounded">Students Fees</a>
                                    <a href="/Admin/ManageTeachers" class="block hover:bg-indigo-100 p-1 rounded">Teachers Fees</a>
                                </div>
                                </div>
                            <div x-data="{ open: false }" class="select-none">
                                <button x-on:click="open = !open"
                                        class="w-full flex justify-between items-center p-2 rounded hover:bg-indigo-100 focus:outline-none"
                                        :aria-expanded="open.toString()" aria-controls="userMgmtDropdown">
                                    Board Documents
                                    <svg :class="{ 'rotate-180': open }"
                                         class="h-4 w-4 transform transition-transform duration-200"
                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>

                                <!-- Dropdown Items -->
                                <div x-show="open" x-collapse x-cloak id="userMgmtDropdown" class="pl-4 mt-1 space-y-1 text-indigo-800">
                                    <a href="/Certificates/Index" class="block hover:bg-indigo-100 p-2 rounded">Certificates</a>
                                    <a href="/BoardAdmissions/Index" class="block hover:bg-indigo-100 p-2 rounded">Board Admissions</a>
                                </div>
                            </div>
                            <a href="/TeacherAttendance/Index" class="block hover:bg-indigo-100 p-2 rounded">Teacher Attendance</a>
                            <a href="/Admin/ManageSubjects" class="block hover:bg-indigo-100 p-2 rounded">Subjects</a>
                            <a href="/Class/Index" class="block hover:bg-indigo-100 p-2 rounded">Classes</a>
                            
                            <a href="/Admin/Analytics" class="block hover:bg-indigo-100 p-2 rounded">Analytics</a>
                            <a href="/Admin/Reports" class="block hover:bg-indigo-100 p-2 rounded">Export Reports</a>
                        }


                        @* Teacher Sidebar *@
                        @if (User.IsInRole("Teacher"))
                        {
                            <a href="/Teacher/Index" class="block hover:bg-indigo-100 p-2 rounded">Dashboard</a>
                            <a href="/Teacher/AssignedClasses" class="block hover:bg-indigo-100 p-2 rounded">My Classes</a>
                            <a href="/Teacher/Subjects" class="block hover:bg-indigo-100 p-2 rounded">Subjects</a>
                            <a href="/Teacher/Attendance" class="block hover:bg-indigo-100 p-2 rounded">Mark Attendance</a>
                            <a href="/Teacher/Grades" class="block hover:bg-indigo-100 p-2 rounded">Manage Grades</a>
                            <a href="/Teacher/Notices" class="block hover:bg-indigo-100 p-2 rounded">Post Notices</a>
                            <a href="/Messages" class="block hover:bg-indigo-100 p-2 rounded">Messages</a>
                        }

                        @* Student Sidebar *@
                        @if (User.IsInRole("Student"))
                        {
                            <a href="/Student/Index" class="block hover:bg-indigo-100 p-2 rounded">Dashboard</a>
                            <a href="/Student/Profile" class="block hover:bg-indigo-100 p-2 rounded">My Profile</a>
                            <a href="/Student/Grades" class="block hover:bg-indigo-100 p-2 rounded">My Grades</a>
                            <a href="/Student/Attendance" class="block hover:bg-indigo-100 p-2 rounded">My Attendance</a>
                            <a href="/Student/Fees" class="block hover:bg-indigo-100 p-2 rounded">Fee Status</a>
                            <a href="/Student/Notices" class="block hover:bg-indigo-100 p-2 rounded">Notices</a>
                            <a href="/Messages" class="block hover:bg-indigo-100 p-2 rounded">Messages</a>
                        }

                        @* Parent Sidebar *@
                        @if (User.IsInRole("Parent"))
                        {
                            <a href="/Parent/Index" class="block hover:bg-indigo-100 p-2 rounded">Dashboard</a>
                            <a href="/Parent/ChildPerformance" class="block hover:bg-indigo-100 p-2 rounded">Child's Progress</a>
                            <a href="/Parent/Attendance" class="block hover:bg-indigo-100 p-2 rounded">Attendance Record</a>
                            <a href="/Parent/Grades" class="block hover:bg-indigo-100 p-2 rounded">Grades</a>
                            <a href="/Parent/FeeStatus" class="block hover:bg-indigo-100 p-2 rounded">Fee Information</a>
                            <a href="/Parent/Notices" class="block hover:bg-indigo-100 p-2 rounded">Notices</a>
                            <a href="/Messages" class="block hover:bg-indigo-100 p-2 rounded">Messages</a>
                        }

                    </nav>

                </div>
            </div>
        }

        <div class="flex-1 flex flex-col overflow-auto min-h-screen relative z-0">
            @if (!isAuthPage)
            {
                <header class="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center space-x-4">
                        <!-- Sidebar Toggle -->
                        <button x-on:click="sidebarOpen = !sidebarOpen" class="text-indigo-600 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                 viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>

                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6">
                            <path fill-rule="evenodd" d="M4.5 2.25a.75.75 0 0 0 0 1.5v16.5h-.75a.75.75 0 0 0 0 1.5h16.5a.75.75 0 0 0 0-1.5h-.75V3.75a.75.75 0 0 0 0-1.5h-15ZM9 6a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5H9Zm-.75 3.75A.75.75 0 0 1 9 9h1.5a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM9 12a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5H9Zm3.75-5.25A.75.75 0 0 1 13.5 6H15a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75ZM13.5 9a.75.75 0 0 0 0 1.5H15A.75.75 0 0 0 15 9h-1.5Zm-.75 3.75a.75.75 0 0 1 .75-.75H15a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75ZM9 19.5v-2.25a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-.75.75h-4.5A.75.75 0 0 1 9 19.5Z" clip-rule="evenodd" />
                        </svg>

                        <a asp-action="Dashboard" asp-controller="Home">

                            <span class="text-xl font-semibold text-indigo-700">School Management</span>
                        </a>
                        
                    </div>

                    <!-- Right section -->
                    <div class="flex items-center space-x-6">
                        <!-- Profile Avatar Icon -->
                        <button x-on:click="profileOpen = !profileOpen" class="relative focus:outline-none">
                            <div class="h-10 w-10 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 font-semibold hover:ring-2 ring-indigo-300 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6">
                                    <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
                                </svg>

                            </div>
                        </button>

                        <!-- Logout -->
                        <form method="post" asp-area="Identity" asp-page="/Account/Logout" class="inline">
                            <button type="submit" class="text-xl font-medium hover:text-black">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                          d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15" />
                                </svg>
                            </button>
                        </form>
                    </div>
                </header>
            }


            <!-- Body content capsule -->
            <main class="flex-1 flex justify-center items-center p-4">
                <div class="bg-white shadow-2xl rounded-xl p-6 w-full h-full max-w-screen-2xl">
                    @RenderBody()
                </div>
            </main>
            <!-- Overlay for profile drawer -->
            <!-- Overlay without fade transition -->
            <div class="fixed inset-0 bg-black bg-opacity-40 z-20"
                 x-show="profileOpen"
                 x-on:click="profileOpen = false"
                 x-cloak></div>

            <!-- Sidebar without slide animation -->
            <div class="fixed top-0 right-0 h-full w-80 bg-white shadow-lg z-30 rounded-l-lg"
                 x-show="profileOpen"
                 x-cloak>

                <!-- Header -->
                <div class="flex justify-between items-center px-5 py-4 border-b bg-indigo-50">
                    <h2 class="text-lg font-semibold text-indigo-700">User Profile</h2>
                    <button x-on:click="profileOpen = false" class="text-gray-500 hover:text-gray-700">✕</button>
                </div>

                <!-- Content -->
                <div class="p-5 space-y-6 text-sm text-gray-700">
                    <div class="flex items-center space-x-4">
                        <div class="h-12 w-12 rounded-full bg-indigo-100 flex items-center justify-center text-lg font-bold text-indigo-700">
                            @User.Identity?.Name?.Substring(0, 1).ToUpper()
                        </div>
                        <div>
                            <div class="text-base font-semibold">@User.Identity?.Name</div>
                            <div class="text-gray-500">@UserManager.GetUserAsync(User).Result?.Email</div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <span class="text-gray-500">Role</span>
                            <div class="text-indigo-600 font-medium">
                                @{
                                    var role = User.IsInRole("Admin") ? "Admin"
                                    : User.IsInRole("Teacher") ? "Teacher"
                                    : User.IsInRole("Student") ? "Student"
                                    : User.IsInRole("Parent") ? "Parent"
                                    : "Unknown";
                                }
                                @role
                            </div>
                        </div>

                        <div>
                            <span class="text-gray-500">Last Login</span>
                            <div class="text-gray-700">@UserManager.GetUserAsync(User).Result?.LockoutEnd?.LocalDateTime.ToString("f") ?? "N/A"</div>
                        </div>

                        <div>
                            <span class="text-gray-500">User ID</span>
                            <div class="text-gray-700">@UserManager.GetUserAsync(User).Result?.Id</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <a href="/Account/Manage" class="block text-indigo-600 font-medium hover:underline">Manage Account</a>
                    </div>
                </div>
            </div>



            @if (!isAuthPage)
            {
                <!-- Footer -->
                <footer class="bg-white border-t p-4 text-sm text-center text-gray-500">
                    &copy; @DateTime.Now.Year School Management System. All rights reserved.
                </footer>
            }
        </div>
    </div>

    @RenderSection("Scripts", required: false)

</body>
</html>
